<script>
// Função para coletar parâmetros da URL (case-insensitive e sem espaços)
function getParam(name) {
    const url = new URL(window.location.href);
    for (const [key, value] of url.searchParams.entries()) {
        if (key.toLowerCase() === name.toLowerCase()) return value.trim();
    }
    return "";
}

// Pega o Código Fixo da URL
const codigoFixo = getParam("ID");
console.log("Código Fixo capturado:", codigoFixo); // Para debug

// ID da sua planilha
const sheetID = "1i2mCgUtb6swVZ8PAyA8HwnO-jVPwPurIywReqZfqChs";
const sheetName = "Página1"; // Nome da aba

// URL em CSV da planilha
const csvURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;

// Converte CSV em JSON
function csvToJson(csv) {
    const lines = csv.split("\n").map(l => l.trim()).filter(l => l.length);
    const headers = lines[0].split(",").map(h => h.trim());
    const rows = lines.slice(1).map(line => {
        const values = line.split(",").map(v => v.trim());
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || "");
        return obj;
    });
    return rows;
}

// Busca a linha correspondente ao Código Fixo
fetch(csvURL)
    .then(res => res.text())
    .then(csv => {
        const data = csvToJson(csv);
        console.log("Dados da planilha carregados:", data);

        // Busca ignorando espaços e nulo
        const row = data.find(r => r["Código Fixo"]?.trim() === codigoFixo);

        if (!row) {
            alert("Nenhum registro encontrado para esse Código Fixo!");
            return;
        }

        // Preenche os campos na tela
        document.getElementById("op").innerText = row["OP"];
        document.getElementById("item").innerText = row["Item"];
        document.getElementById("prev").innerText = row["Quantidade Prevista"];
        document.getElementById("prod").innerText = row["Quantidade Produzida"];
        document.getElementById("status").innerText = row["Status"];
        document.getElementById("obs").innerText = row["Observação"];
        document.getElementById("local").innerText = row["Local"];
        document.getElementById("turno").innerText = row["Turno"];
        document.getElementById("inicio").innerText = row["Data de Início"];
        document.getElementById("termino").innerText = row["Data de Término"];

        // Gera QR Code apontando para esta mesma página
        const fullLink = window.location.href;
        document.getElementById("qrImg").src =
            "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(fullLink);
    })
    .catch(err => console.error("Erro ao buscar planilha:", err));
</script>
